#!/bin/sh

# Pre-commit safety checks for Holly v6
# Prevents committing placeholder/stub text or missing changelog updates.

FORBIDDEN='(\.\.\.|placeholder|unchanged)'

# Scan staged files for forbidden patterns
if git diff --cached --name-only | grep -E '\.(ts|tsx|py|md)$' | xargs grep -nE "$FORBIDDEN"; then
  echo "❌ Commit rejected: placeholder/stub text found."
  echo "Remove placeholders before committing."
  exit 1
fi

# Ensure schema/API changes update CHANGELOG.md
touched=$(git diff --cached --name-only)
if echo "$touched" | grep -qE 'apps/backend/(models|schemas)\.py|apps/backend/main\.py'; then
  if ! echo "$touched" | grep -q 'docs/CHANGELOG.md'; then
    echo "❌ Commit rejected: Schema/API change without CHANGELOG update."
    echo "Please update docs/CHANGELOG.md with details."
    exit 1
  fi
fi

# Prevent stray UI libraries in frontend
if echo "$touched" | grep -q 'apps/frontend/'; then
  if git diff --cached | grep -E 'from .*(tailwind|chakra|antd|shadcn)'; then
    echo "❌ Commit rejected: Stray UI library import detected in frontend."
    echo "Frontend must use MUI Core + Joy UI only."
    exit 1
  fi
fi

exit 0